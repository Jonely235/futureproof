---
phase: 04-settings-screen-refactor
plan: 03
type: execute
domain: flutter
---

<objective>
Extract settings form widget from SettingsScreen into a reusable, testable component.

Purpose: Reduce SettingsScreen complexity by isolating financial goals form (income/savings inputs) into a focused widget. Enable independent testing of form validation and submission.
Output: FinancialGoalsFormWidget in lib/widgets/financial_goals_form_widget.dart, SettingsScreen updated to use extracted widget.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@lib/screens/settings_screen.dart
@lib/theme/theme_manager.dart
@lib/widgets/theme_picker_widget.dart (from 04-01)
@lib/widgets/smart_insights_widget.dart (from 04-02)
@lib/widgets/bar_chart_widget.dart
@.planning/phases/01-logging-foundation/01-03-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-01-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-02-SUMMARY.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/03-error-handling/03-01-SUMMARY.md
@.planning/phases/02-constants-config/02-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@lib/screens/settings_screen.dart
@lib/widgets/financial_goals_form_widget.dart (to be created)

**Tech stack available:** Flutter widget composition, TextEditingController, SharedPreferences, form validation, Google Fonts
**Established patterns:** StatefulWidget for local state, TextEditingController management, form validation, callback patterns
**Constraining decisions:**
- [Phase 1]: Use AppLogger.widgets for logging (not print statements)
- [Phase 3]: Use consistent error handling patterns
- [Phase 4-01, 04-02]: Widget extraction pattern established

**Issues being addressed:**
- Settings screen is ~824 lines after 04-02
- Financial goals section contains form state and validation logic

**Issues being addressed:**
None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FinancialGoalsFormWidget with form state and validation</name>
  <files>lib/widgets/financial_goals_form_widget.dart</files>
  <action>Create new StatefulWidget called FinancialGoalsFormWidget. Extract financial goals form from SettingsScreen:
- Extract form state: _incomeController, _savingsController, _isLoading, _isSaving
- Extract _loadSettings() method (SharedPreferences loading logic)
- Extract _saveSettings() method (validation and saving logic)
- Extract _resetToDefaults() method (reset confirmation and logic)
- Extract form UI from build method (lines ~596-637) - income and savings input fields
- Use TextEditingController for both fields
- Validate: income must be > 0, savings must be >= 0
- Show SnackBar for validation errors (red) and success (black)
- Use HapticFeedback for user feedback
- Call SharedPreferences for persistence
- Maintain exact same UI appearance and behavior
- Use Google Fonts (jetBrainsMono for monetary inputs)
- Follow widget patterns from previous plans
- Add AppLogger.widgets for debugging

File location: lib/widgets/financial_goals_form_widget.dart
</action>
  <verify>File exists with FinancialGoalsFormWidget class, form state management, validation logic, SharedPreferences integration, no Dart analysis errors</verify>
  <done>FinancialGoalsFormWidget created with income/savings form, validation, loading, saving, and reset functionality</done>
</task>

<task type="auto">
  <name>Task 2: Update SettingsScreen to use FinancialGoalsFormWidget</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>Modify SettingsScreen to use the extracted FinancialGoalsFormWidget:
- Remove form-related state variables: _incomeController, _savingsController, _isLoading, _isSaving
- Remove form-related methods:
  - _loadSettings()
  - _saveSettings()
  - _resetToDefaults()
- Remove initState() (no longer needed - loading handled by widget)
- Remove dispose() (no controllers to dispose - handled by widget)
- Add import: import '../widgets/financial_goals_form_widget.dart';
- Replace financial goals section in build method with FinancialGoalsFormWidget widget
- No callbacks needed (widget manages its own state)
- Keep action buttons (Save Settings, Reset to Defaults) in widget
- Test that form loading, validation, and saving still work

Do NOT modify any other sections of SettingsScreen - only the financial goals section.
</action>
  <verify>SettingsScreen no longer contains form state or methods, imports FinancialGoalsFormWidget, app compiles and runs, form loads/saves/resets correctly</verify>
  <done>SettingsScreen uses FinancialGoalsFormWidget, form functionality preserved, file is ~150 lines shorter</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>FinancialGoalsFormWidget extracted and integrated into SettingsScreen</what-built>
  <how-to-verify>
    1. Run: flutter run (or start app normally)
    2. Navigate to Settings screen
    3. Scroll to Financial Goals section
    4. Verify current income and savings load from storage
    5. Try entering invalid income (0 or negative) - verify error shows
    6. Try entering invalid savings (negative) - verify error shows
    7. Enter valid values and tap "Save Settings" - verify success message
    8. Close and reopen app - verify values persist
    9. Tap "Reset to Defaults" - confirm reset, verify values reset to defaults
    10. Check console for AppLogger.widgets messages
    11. Confirm UI looks identical to before extraction
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `flutter analyze` passes with no errors
- [ ] `dart format --output=none --set-exit-if-changed .` passes
- [ ] Form loads saved values correctly
- [ ] Form validation works (invalid input shows errors)
- [ ] Save functionality persists values to SharedPreferences
- [ ] Reset functionality clears to defaults
- [ ] Haptic feedback works on all interactions
- [ ] Settings screen reduced by ~150 lines
</verification>

<success_criteria>

- FinancialGoalsFormWidget exists as independent, reusable widget
- SettingsScreen uses FinancialGoalsFormWidget instead of form methods
- Form functionality unchanged (load, save, reset, validation)
- Code follows established widget patterns
- No Dart analysis errors
- User verified form works correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/04-settings-screen-refactor/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Financial Goals Form Extraction Summary

**Extracted financial goals form into reusable FinancialGoalsFormWidget with state management**

## Accomplishments

- Created FinancialGoalsFormWidget as independent, testable component
- Extracted form state, validation, loading, saving, and reset logic
- Reduced SettingsScreen by ~150 lines
- Preserved all form functionality (validation, persistence, haptics)
- Form is now independently testable

## Files Created/Modified

- `lib/widgets/financial_goals_form_widget.dart` - New extracted widget with form logic
- `lib/screens/settings_screen.dart` - Updated to use FinancialGoalsFormWidget

## Decisions Made

- Extract as StatefulWidget (form has local state that doesn't belong in parent)
- Keep all form state in widget (controllers, loading, saving states)
- Include action buttons in widget (Save, Reset) - self-contained form component
- Maintain exact UI behavior from original implementation

## Issues Encountered

None

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

âœ… Financial goals form extraction complete - widget is independent and self-contained
- Ready for 04-04 (Backup Section extraction - final plan)
- Settings screen reduced from ~824 to ~674 lines
- Pattern established: StatefulWidget for components with local state

---
*Phase: 04-settings-screen-refactor*
*Plan: 03*
*Completed: 2026-01-11*
</output>
