---
phase: 04-settings-screen-refactor
plan: 02
type: execute
domain: flutter
---

<objective>
Extract smart insights widget from SettingsScreen into a reusable, testable component.

Purpose: Reduce SettingsScreen complexity by isolating financial insights UI into a focused widget. Enable independent testing of insights display logic.
Output: SmartInsightsWidget in lib/widgets/smart_insights_widget.dart, SettingsScreen updated to use extracted widget.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@lib/screens/settings_screen.dart
@lib/services/analytics_service.dart
@lib/widgets/theme_picker_widget.dart (from 04-01)
@lib/widgets/bar_chart_widget.dart
@.planning/phases/01-logging-foundation/01-03-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-01-SUMMARY.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/03-error-handling/03-01-SUMMARY.md
@.planning/phases/02-constants-config/02-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@lib/screens/settings_screen.dart
@lib/services/analytics_service.dart
@lib/widgets/smart_insights_widget.dart (to be created)

**Tech stack available:** Flutter widget composition, FutureBuilder, AnalyticsService, Google Fonts, circular progress indicators
**Established patterns:** StatelessWidget for reusable components, const constructors, named parameters, FutureBuilder for async data
**Constraining decisions:**
- [Phase 1]: Use AppLogger.widgets for logging (not print statements)
- [Phase 3]: Use consistent error handling patterns
- [Phase 4-01]: Widget extraction pattern established (StatelessWidget, file naming)

**Issues being addressed:**
- Settings screen is 1174 lines after 04-01 (down from 1274)
- Smart insights section contains multiple helper methods that should be co-located

**Issues being addressed:**
None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SmartInsightsWidget with core insights display</name>
  <files>lib/widgets/smart_insights_widget.dart</files>
  <action>Create new StatelessWidget called SmartInsightsWidget. Extract insights UI from SettingsScreen._buildSmartInsights() and related helpers:
- Extract _buildSmartInsights() (lines ~189-295)
- Extract _buildStatCard() (lines ~346-392)
- Extract _buildCircularProgressCard() (lines ~393-447)
- Extract _buildTipCard() (lines ~448-481)
- Extract _buildCategoryAlert() (lines ~482-549)
- Extract _getStreakDays() (helper method)
- Extract _getDailyTip() (helper method)
- Use FutureBuilder<Map<String, dynamic>> for async data loading
- Call AnalyticsService().getQuickStats() for data
- Maintain exact same UI appearance (4 stat cards in 2x2 grid, tip card, category alert)
- Use Google Fonts (playfairDisplay for section headers)
- Follow widget patterns from 04-01 (StatelessWidget, const constructors)
- Add AppLogger.widgets for debugging

File location: lib/widgets/smart_insights_widget.dart
</action>
  <verify>File exists with SmartInsightsWidget class, all helper methods extracted, imports correct (flutter, services, widgets), no Dart analysis errors</verify>
  <done>SmartInsightsWidget created with insights display, stat cards, circular progress, tip card, and category alert</done>
</task>

<task type="auto">
  <name>Task 2: Update SettingsScreen to use SmartInsightsWidget</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>Modify SettingsScreen to use the extracted SmartInsightsWidget:
- Remove _buildSmartInsights() and all related helper methods:
  - _buildStatCard()
  - _buildCircularProgressCard()
  - _buildTipCard()
  - _buildCategoryAlert()
  - _getStreakDays()
  - _getDailyTip()
- Add import: import '../widgets/smart_insights_widget.dart';
- Replace _buildSmartInsights() call in build method with SmartInsightsWidget widget
- No parameters needed (widget fetches its own data via AnalyticsService)
- Ensure widget handles loading/error states via FutureBuilder
- Test that insights display correctly with real data

Do NOT modify any other sections of SettingsScreen - only the smart insights section.
</action>
  <verify>SettingsScreen no longer contains insights methods, imports SmartInsightsWidget, app compiles and runs, insights display with data</verify>
  <done>SettingsScreen uses SmartInsightsWidget, insights functionality preserved, file is ~350 lines shorter</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>SmartInsightsWidget extracted and integrated into SettingsScreen</what-built>
  <how-to-verify>
    1. Run: flutter run (or start app normally)
    2. Navigate to Settings screen
    3. Scroll to Smart Insights section
    4. Verify stat cards display (Remaining, Budget OK, Savings, Day Streak)
    5. Check circular progress indicator shows budget status
    6. Verify tip of the day displays
    7. If top category > 30% of income, verify category alert appears
    8. Check console for AppLogger.widgets messages
    9. Confirm UI looks identical to before extraction
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `flutter analyze` passes with no errors
- [ ] `dart format --output=none --set-exit-if-changed .` passes
- [ ] Smart insights display correctly with real transaction data
- [ ] All stat cards show correct values
- [ ] Circular progress indicator works
- [ ] Tip card displays
- [ ] Category alert appears when applicable
- [ ] Settings screen reduced by ~350 lines
</verification>

<success_criteria>

- SmartInsightsWidget exists as independent, reusable widget
- SettingsScreen uses SmartInsightsWidget instead of insights methods
- Insights functionality unchanged (all stats display correctly)
- Code follows established widget patterns
- No Dart analysis errors
- User verified insights display works correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/04-settings-screen-refactor/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Smart Insights Extraction Summary

**Extracted smart insights into reusable SmartInsightsWidget with all helper methods**

## Accomplishments

- Created SmartInsightsWidget as independent, testable component
- Extracted 6 helper methods along with main widget
- Reduced SettingsScreen by ~350 lines
- Preserved all insights functionality (4 stat cards, progress, tip, alert)
- Followed widget extraction pattern established in 04-01

## Files Created/Modified

- `lib/widgets/smart_insights_widget.dart` - New extracted widget with all insights logic
- `lib/screens/settings_screen.dart` - Updated to use SmartInsightsWidget

## Decisions Made

- Extract all related helper methods with main widget (stat cards, progress, tip, alert)
- Keep data fetching in widget (AnalyticsService call via FutureBuilder)
- Maintain exact UI appearance from original implementation
- Co-locate all insights logic in single file for easier testing

## Issues Encountered

None

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

âœ… Smart insights extraction complete - widget is independent and self-contained
- Ready for 04-03 (Settings Form extraction)
- Settings screen reduced from ~1174 to ~824 lines
- Pattern established: extract widget with all related helper methods

---
*Phase: 04-settings-screen-refactor*
*Plan: 02*
*Completed: 2026-01-11*
</output>
