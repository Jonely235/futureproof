---
phase: 04-settings-screen-refactor
plan: 04
type: execute
domain: flutter
---

<objective>
Extract backup section widget from SettingsScreen into a reusable, testable component - final refactoring step for Phase 4.

Purpose: Complete SettingsScreen refactoring by isolating backup/export/import UI into a focused widget. Enable independent testing of backup functionality.
Output: BackupSectionWidget in lib/widgets/backup_section_widget.dart, SettingsScreen updated to use extracted widget. Phase 4 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@lib/screens/settings_screen.dart
@lib/services/backup_service.dart
@lib/widgets/theme_picker_widget.dart (from 04-01)
@lib/widgets/smart_insights_widget.dart (from 04-02)
@lib/widgets/financial_goals_form_widget.dart (from 04-03)
@lib/widgets/bar_chart_widget.dart
@.planning/phases/01-logging-foundation/01-03-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-01-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-02-SUMMARY.md
@.planning/phases/04-settings-screen-refactor/04-03-SUMMARY.md

# Auto-selected based on dependency graph (from frontmatter):
@.planning/phases/03-error-handling/03-01-SUMMARY.md
@.planning/phases/02-constants-config/02-01-SUMMARY.md

# Key files from frontmatter (relevant to this phase):
@lib/screens/settings_screen.dart
@lib/services/backup_service.dart
@lib/widgets/backup_section_widget.dart (to be created)

**Tech stack available:** Flutter widget composition, BackupService, file sharing (share_plus), SnackBar, Google Fonts
**Established patterns:** StatelessWidget for reusable components, service integration, user feedback via SnackBar
**Constraining decisions:**
- [Phase 1]: Use AppLogger.widgets for logging (not print statements)
- [Phase 3]: Use consistent error handling patterns
- [Phase 4-01, 04-02, 04-03]: Widget extraction pattern established

**Issues being addressed:**
- Settings screen is ~674 lines after 04-03 (down from 1274)
- Backup section contains export/import functionality that should be isolated

**Issues being addressed:**
None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BackupSectionWidget with export/import functionality</name>
  <files>lib/widgets/backup_section_widget.dart</files>
  <action>Create new StatelessWidget called BackupSectionWidget. Extract backup UI from SettingsScreen._buildBackupSection():
- Extract _buildBackupSection() method (lines ~984-end, likely ~100-150 lines)
- Extract export/import button handlers
- Integrate BackupService for data operations:
  - exportData() for backup (JSON export)
  - importData() for restore (JSON import)
- Use SharePlatform (or similar) for file sharing
- Show SnackBar for export success/errors
- Show confirmation dialog for import
- Show SnackBar for import success/errors
- Maintain exact same UI appearance (export button, import button, descriptions)
- Use Google Fonts (spaceGrotesk for buttons)
- Follow widget patterns from previous plans
- Add AppLogger.widgets for debugging

File location: lib/widgets/backup_section_widget.dart
Import BackupService: import '../services/backup_service.dart';
</action>
  <verify>File exists with BackupSectionWidget class, export/import handlers, BackupService integration, no Dart analysis errors</verify>
  <done>BackupSectionWidget created with export/import buttons, service integration, user feedback via SnackBar</done>
</task>

<task type="auto">
  <name>Task 2: Update SettingsScreen to use BackupSectionWidget</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>Modify SettingsScreen to use the extracted BackupSectionWidget:
- Remove _buildBackupSection() method
- Add import: import '../widgets/backup_section_widget.dart';
- Replace _buildBackupSection() call in build method with BackupSectionWidget widget
- No parameters needed (widget manages its own backup operations)
- Ensure export/import functionality still works via BackupService
- Test that export generates JSON file
- Test that import loads JSON file and restores data

Do NOT modify any other sections of SettingsScreen - only the backup section.
After this change, SettingsScreen should only contain:
- Scaffold with SliverAppBar
- Section headers and wrappers (_buildSectionHeader, _buildSettingsSection, _buildInfoRow)
- Composed widgets (ThemePickerWidget, SmartInsightsWidget, FinancialGoalsFormWidget, BackupSectionWidget)
- About section with version info
</action>
  <verify>SettingsScreen no longer contains _buildBackupSection method, imports BackupSectionWidget, app compiles and runs, export/import work</verify>
  <done>SettingsScreen uses BackupSectionWidget, backup functionality preserved, file is ~100-150 lines shorter</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>BackupSectionWidget extracted and integrated, Phase 4 refactoring complete</what-built>
  <how-to-verify>
    1. Run: flutter run (or start app normally)
    2. Navigate to Settings screen
    3. Scroll to Backup & Export section
    4. Tap "Export Data" button - verify JSON file is generated/shared
    5. Note the exported file location
    6. Tap "Import Data" button - verify confirmation dialog appears
    7. Select the previously exported JSON file
    8. Verify import success message appears
    9. Check that transaction data is restored correctly
    10. Check console for AppLogger.widgets messages
    11. Confirm UI looks identical to before extraction
    12. Verify Settings screen is now much shorter and more readable

    BONUS: Check lib/screens/settings_screen.dart line count - should be ~500-550 lines (down from 1274)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan and phase complete:
- [ ] `flutter analyze` passes with no errors
- [ ] `dart format --output=none --set-exit-if-changed .` passes
- [ ] Export functionality works (generates valid JSON)
- [ ] Import functionality works (restores data from JSON)
- [ ] User feedback works (SnackBar messages)
- [ ] Import confirmation dialog shows
- [ ] Settings screen reduced to ~500-550 lines (from 1274)
- [ ] All sections extracted as independent widgets
</verification>

<success_criteria>

- BackupSectionWidget exists as independent, reusable widget
- SettingsScreen uses BackupSectionWidget instead of backup methods
- Backup/import functionality unchanged (export JSON, import JSON)
- Code follows established widget patterns
- No Dart analysis errors
- User verified backup/import works correctly
- **Phase 4 complete**: SettingsScreen refactored from 1274 lines to ~500-550 lines
- **4 new widgets created**: ThemePickerWidget, SmartInsightsWidget, FinancialGoalsFormWidget, BackupSectionWidget
  </success_criteria>

<output>
After completion, create `.planning/phases/04-settings-screen-refactor/04-04-SUMMARY.md`:

# Phase 4 Plan 4: Backup Section Extraction Summary

**Extracted backup section into reusable BackupSectionWidget, completing Phase 4 refactoring**

## Accomplishments

- Created BackupSectionWidget as independent, testable component
- Reduced SettingsScreen by ~100-150 lines
- Preserved all backup/import functionality
- **Phase 4 Complete**: SettingsScreen refactored from 1274 to ~500-550 lines
- **4 widgets extracted**: ThemePicker, SmartInsights, FinancialGoalsForm, BackupSection
- Each widget is now independently testable and reusable

## Files Created/Modified

- `lib/widgets/backup_section_widget.dart` - New extracted widget with backup logic
- `lib/screens/settings_screen.dart` - Updated to use BackupSectionWidget

## Decisions Made

- Extract as StatelessWidget (operations are async, no local state needed)
- Keep service integration in widget (BackupService calls)
- Include all backup functionality (export, import, confirmation, feedback)
- Maintain exact UI behavior from original implementation

## Issues Encountered

None

## Deviations from Plan

None - plan executed exactly as written.

## Phase 4 Summary

**Original State**: SettingsScreen was 1274 lines with multiple responsibilities
**Final State**: SettingsScreen is ~500-550 lines, composed of 4 focused widgets

**Widgets Created:**
1. **ThemePickerWidget** (04-01): Theme selection UI, ~100 lines extracted
2. **SmartInsightsWidget** (04-02): Financial insights display, ~350 lines extracted
3. **FinancialGoalsFormWidget** (04-03): Income/savings form with validation, ~150 lines extracted
4. **BackupSectionWidget** (04-04): Export/import functionality, ~100-150 lines extracted

**Benefits Achieved:**
- Each widget can be tested independently
- SettingsScreen is now readable and maintainable
- Widgets are reusable in other contexts
- Follows single responsibility principle
- Consistent with established Flutter widget patterns

## Next Phase Readiness

✅ **Phase 4 (Settings Screen Refactor) COMPLETE**
- SettingsScreen reduced from 1274 to ~500-550 lines (~57% reduction)
- All 4 widgets extracted and working correctly
- No blockers for Phase 5 (Service Tests)
- Refactored widgets are easier to test than monolithic screen
- Code follows all established conventions and patterns

**Phase 5 (Service Tests) will now be easier:**
- AnalyticsService tested independently (SmartInsightsWidget already uses it)
- BackupService tested independently (BackupSectionWidget already uses it)
- Widget tests can mock services more easily

---
*Phase: 04-settings-screen-refactor*
*Plan: 04 (Final plan of phase)*
*Completed: 2026-01-11*
*Phase Status: ✅ COMPLETE*
</output>
