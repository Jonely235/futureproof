---
phase: 05-service-tests
plan: 03
type: tdd
domain: flutter-testing
---

<objective>
Expand DatabaseService tests to improve coverage beyond basic serialization tests.

Purpose: Current database_service_test.dart only covers serialization (toMap/fromMap). Need to add tests for CRUD operations, query methods, and database initialization.

Output: test/services/database_service_test.dart with expanded coverage of DatabaseService CRUD and query operations
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md
@.planning/codebase/ARCHITECTURE.md
@lib/services/database_service.dart
@test/services/database_service_test.dart (existing - serialization only)

**Tech stack available:**
- Flutter test framework (built-in)
- sqflite_ffi_test for in-memory database testing (if available)
- Existing serialization tests as reference

**Established patterns:**
- Current tests only cover Transaction serialization
- Need to add actual database operation tests

**Key files to reference:**
- lib/services/database_service.dart - Service under test (read to understand CRUD methods)
- test/services/database_service_test.dart - Existing tests (append new groups)

**Dependencies:**
- Plans 05-01, 05-02 - for TDD patterns
</context>

<feature>
  <name>Expanded DatabaseService Tests</name>
  <files>test/services/database_service_test.dart</files>
  <behavior>
    DatabaseService has CRUD operations that need testing. After reading the service file, test:

    1. **Database initialization** - database open, table creation
    2. **addTransaction()** - Insert transaction, return success/failure
    3. **updateTransaction()** - Modify existing transaction by ID
    4. **deleteTransaction()** - Remove transaction by ID
    5. **getAllTransactions()** - Retrieve all transactions, sorted by date
    6. **getTransactionsByDateRange()** - Query transactions between dates
    7. **getTransactionById()** - Query single transaction by ID
    8. **clearAllTransactions()** - Delete all data
    9. Error handling - duplicate IDs, missing IDs, database errors

    Test cases should include:
    - Add transaction and verify it exists
    - Update transaction and verify changes persisted
    - Delete transaction and verify it's removed
    - Query by date range returns correct transactions
    - Query by ID returns correct transaction
    - Clear all removes everything
    - Error cases: update/delete non-existent ID
    - Sorting order (newest first)

    Note: Full database integration tests may require platform-specific setup (sqflite_ffi for testing). Focus on:
    - In-memory database if possible
    - Or mock database operations for unit tests
  </behavior>
  <implementation>
    Two approaches (verify which works with Flutter test):

    **Option A: In-memory database** (preferred if sqflite_ffi available)
    - Use sqflite_ffi for cross-platform testing
    - Create in-memory database for each test
    - Test actual CRUD operations

    **Option B: Mock-based unit tests** (fallback)
    - Mock sqflite Database interface
    - Verify correct SQL queries are generated
    - Test error handling with mock errors

    Add new test groups to existing file:
    - group('Database CRUD Operations', ...) { ... }
    - group('Database Query Operations', ...) { ... }
    - group('Database Error Handling', ...) { ... }
  </implementation>
</feature>

<verification>
Run: flutter test test/services/database_service_test.dart
Expected: All original tests pass, new CRUD tests pass
</verification>

<success_criteria>

- Added test groups for CRUD operations
- Tests cover add, update, delete, query operations
- Error cases tested (missing IDs, database errors)
- Sorting/ordering verified
- All tests pass (existing + new)
- Coverage increased from ~30% to 70%+
  </success_criteria>

<output>
After completion, create `.planning/phases/05-service-tests/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Expanded DatabaseService Tests Summary

**Expanded DatabaseService test coverage to include CRUD and query operations**

## Accomplishments

- Added test groups for database CRUD operations
- Tested add, update, delete, query operations
- Verified error handling for missing/invalid IDs
- Confirmed sorting and ordering behavior
- Increased coverage from ~30% to 70%+

## Files Created/Modified

- `test/services/database_service_test.dart` - Modified: added CRUD, query, error handling groups

## Decisions Made

- [Chosen approach: in-memory or mock-based]
- Kept existing serialization tests intact
- Used setUp/tearDown to create fresh database for each test

## Issues Encountered

[Issues if any, e.g., sqflite compatibility, test setup challenges]

## Next Step

Ready for 05-04-PLAN.md (Expand FinanceCalculator tests)
</output>
