---
phase: 05-service-tests
plan: 01
type: tdd
domain: flutter-testing
---

<objective>
Add comprehensive tests for AnalyticsService to ensure all analytics calculations work correctly.

Purpose: AnalyticsService contains critical business logic for spending analysis, insights, trends, and financial health scoring. Tests ensure calculations remain correct during refactoring.

Output: test/services/analytics_service_test.dart with 80%+ coverage of AnalyticsService methods
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@lib/services/analytics_service.dart
@test/services/database_service_test.dart
@test/services/finance_calculator_test.dart

**Tech stack available:**
- Flutter test framework (built-in)
- Existing test patterns in database_service_test.dart and finance_calculator_test.dart

**Established patterns:**
- Test file naming: test/services/[service]_service_test.dart
- Use group() to organize tests by method
- Use testWidgets() for widget tests, test() for unit tests
- Mock SharedPreferences and DatabaseService for service tests
- Descriptive test names with spaces

**Key files to reference:**
- lib/services/analytics_service.dart - Service under test
- lib/models/spending_analysis.dart - Return type for many methods
- lib/config/finance_config.dart - Config for penalties and bonuses

**Dependencies:**
- Phase 3 (Error Handling) - not complete yet, but logging foundation from Phase 1 is sufficient for tests
</context>

<feature>
  <name>AnalyticsService Tests</name>
  <files>test/services/analytics_service_test.dart</files>
  <behavior>
    All public methods in AnalyticsService must be tested:

    1. **refresh()** - Clears cache, _getAnalysis returns fresh data
    2. **analyzeSpending()** - Returns SpendingAnalysis from transactions
    3. **getCategoryBreakdown()** - Returns Map<String, double> of spending by category
    4. **getMonthlyTrends()** - Returns List<MonthlySpending>
    5. **getTopCategory()** - Returns MapEntry with highest-spending category or null
    6. **detectAnomalies()** - Returns list of anomalous transactions
    7. **generateInsights()** - Returns list of Insight objects
    8. **getBudgetComparisons()** - Returns budget vs actual for each category
    9. **predictNextMonth()** - Returns predicted spending amount
    10. **isTrendingUp()** - Returns boolean for spending trend
    11. **getTrendPercentage()** - Returns percentage change
    12. **calculateSavingsRate()** - Returns savings as percentage of income
    13. **getFinancialHealthScore()** - Returns 0-100 score based on budget, anomalies, savings, trends
    14. **getDailySpendingVelocity()** - Returns average daily spending for current month
    15. **getSpendingByDayOfWeek()** - Returns Map<int, double> (1=Monday, 7=Sunday)
    16. **getAverageCategorySpending(String)** - Returns average per transaction in category
    17. **compareMonths()** - Returns current vs previous month comparison map
    18. **getQuickStats()** - Returns comprehensive stats map

    Test cases should include:
    - Empty data scenarios (no transactions)
    - Single transaction
    - Multiple transactions across categories
    - Edge cases (zero income, all income, negative amounts)
    - Caching behavior (refresh clears cache, subsequent calls use cache)
    - Budget scenarios (over budget, under budget, no budget)
  </behavior>
  <implementation>
    Follow existing test patterns from finance_calculator_test.dart:
    - Use group() for each method
    - Use descriptive test names
    - Mock DatabaseService to return test transactions
    - Mock SharedPreferences for income/savings/budget settings
    - Test with various transaction scenarios
    - Verify return values match expected calculations
    - Test edge cases (empty, single item, outliers)
  </implementation>
</feature>

<verification>
Run: flutter test test/services/analytics_service_test.dart
Expected: All tests pass, 0 failures
</verification>

<success_criteria>

- All 18 AnalyticsService methods have tests
- Tests cover empty data, single item, multiple items scenarios
- Edge cases tested (zero income, no budgets, all income)
- Cache behavior verified (refresh works)
- All tests pass (flutter test)
- 80%+ coverage measured by flutter test --coverage
  </success_criteria>

<output>
After completion, create `.planning/phases/05-service-tests/05-01-SUMMARY.md`:

# Phase 5 Plan 1: AnalyticsService Tests Summary

**Added comprehensive test coverage for AnalyticsService's 18 analytics methods**

## Accomplishments

- Created test/services/analytics_service_test.dart
- Tested all 18 public methods in AnalyticsService
- Verified caching behavior (refresh, cache hit)
- Tested edge cases: empty data, zero income, no budgets
- Validated financial health score calculations
- Verified trend detection and prediction logic

## Files Created/Modified

- `test/services/analytics_service_test.dart` - Created with 18 method groups, 50+ test cases

## Decisions Made

- Mocked DatabaseService and SharedPreferences per existing patterns
- Used helper methods to create test transactions for reusability
- Grouped tests by method for organization
- Focused on behavior testing rather than implementation details

## Issues Encountered

None

## Next Step

Ready for 05-02-PLAN.md (BackupService tests)
</output>
