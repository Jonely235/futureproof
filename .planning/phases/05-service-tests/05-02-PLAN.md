---
phase: 05-service-tests
plan: 02
type: tdd
domain: flutter-testing
---

<objective>
Add comprehensive tests for BackupService to ensure data export/import and backup functionality works correctly.

Purpose: BackupService handles critical data persistence (JSON export/import) and backup tracking. Tests ensure users can safely backup and restore their financial data.

Output: test/services/backup_service_test.dart with 80%+ coverage of BackupService methods
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@lib/services/backup_service.dart
@test/services/analytics_service_test.dart (from 05-01)

**Tech stack available:**
- Flutter test framework (built-in)
- dart:convert for JSON testing
- Existing test patterns from 05-01

**Established patterns:**
- Mock DatabaseService and SharedPreferences
- Use group() to organize tests by method
- Test with various data scenarios

**Key files to reference:**
- lib/services/backup_service.dart - Service under test
- lib/models/transaction.dart - Transaction structure for test data
- lib/utils/app_logger.dart - Logging (already configured)

**Dependencies:**
- Plan 05-01 (AnalyticsService tests) - for test pattern reference
</context>

<feature>
  <name>BackupService Tests</name>
  <files>test/services/backup_service_test.dart</files>
  <behavior>
    All public methods in BackupService must be tested:

    1. **exportData()** - Exports all transactions + settings to formatted JSON string
       - Returns valid JSON with version, exportDate, settings, transactions
       - Uses 2-space indentation
       - Logs success/failure via AppLogger

    2. **importData(String)** - Imports from JSON string, returns ImportResult
       - Success case: returns ImportResult(success: true, importedCount: N, skippedCount: M)
       - Missing transactions key: throws FormatException
       - Invalid JSON: returns ImportResult(success: false, errorMessage: ...)
       - Duplicate detection: skips existing transactions by ID
       - Imports settings if present (monthly_income, savings_goal, selected_theme)

    3. **getExportFilename()** - Returns formatted filename
       - Format: futureproof_backup_YYYY-MM-DD_HH-mm.json
       - Uses current timestamp

    4. **getLastBackupDate()** - Returns DateTime? from SharedPreferences
       - Returns null if no timestamp stored
       - Returns DateTime from millisecondsSinceEpoch if stored

    5. **saveLastBackupDate()** - Saves current timestamp to SharedPreferences
       - Stores millisecondsSinceEpoch as int

    6. **ImportResult.toString()** - Returns human-readable result
       - Success: "Imported N transactions"
       - Failure: "Import failed: [error message]"

    Test cases should include:
    - Export with empty transactions
    - Export with multiple transactions
    - Export with settings present
    - Import valid JSON with new transactions
    - Import with duplicate transactions (skip existing)
    - Import with invalid JSON structure
    - Import with missing fields
    - Settings import/export
    - Backup date tracking
    - Filename format validation
  </behavior>
  <implementation>
    Follow test patterns from 05-01:
    - Mock DatabaseService to return test transactions or check for existing IDs
    - Mock SharedPreferences for settings storage
    - Use group() for each method
    - Test JSON structure directly (parse export, validate fields)
    - Test duplicate detection logic
    - Verify error handling for malformed JSON
  </implementation>
</feature>

<verification>
Run: flutter test test/services/backup_service_test.dart
Expected: All tests pass, JSON structure validated, duplicate detection verified
</verification>

<success_criteria>

- All 6 public BackupService methods have tests
- Export produces valid JSON with required fields (version, exportDate, settings, transactions)
- Import handles new, duplicate, and invalid data correctly
- Settings import/export tested
- Backup date tracking tested
- Filename format validated
- Error cases tested (missing fields, invalid JSON, malformed data)
- All tests pass (flutter test)
- 80%+ coverage
  </success_criteria>

<output>
After completion, create `.planning/phases/05-service-tests/05-02-SUMMARY.md`:

# Phase 5 Plan 2: BackupService Tests Summary

**Added comprehensive test coverage for BackupService export/import functionality**

## Accomplishments

- Created test/services/backup_service_test.dart
- Tested all 6 public methods in BackupService
- Verified JSON export structure (version, exportDate, settings, transactions)
- Tested import with new, duplicate, and invalid data
- Validated settings import/export
- Verified backup date tracking
- Confirmed filename format

## Files Created/Modified

- `test/services/backup_service_test.dart` - Created with 6 method groups, 30+ test cases

## Decisions Made

- Parsed JSON directly in tests to validate structure
- Created helper methods for generating test transactions
- Tested both success and failure paths for importData

## Issues Encountered

None

## Next Step

Ready for 05-03-PLAN.md (Expand DatabaseService tests)
</output>
