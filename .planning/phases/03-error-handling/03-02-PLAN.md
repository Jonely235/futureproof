---
phase: 03-error-handling
plan: 02
type: execute
---

<objective>
Standardize UI error display patterns with consistent SnackBar formatting and user-friendly messaging.

Purpose: Create reusable error display utilities that transform AppError into user-friendly SnackBar messages, ensuring consistent error communication across all screens.

Output: ErrorDisplay utility class, all screens using consistent error display patterns, user-friendly error messages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/03-error-handling/03-01-SUMMARY.md

# Key files from Phase 3 Plan 1:
@lib/models/app_error.dart
@lib/services/database_service.dart
@lib/services/analytics_service.dart
@lib/services/backup_service.dart

# Tech stack available:
- AppError class hierarchy (from Plan 1)
- AppLogger utility for error logging
- Flutter SnackBar for UI notifications

# Established patterns:
- AppError with type enum and message properties
- Component-specific loggers
- Error logging before throwing

# Current error display patterns (from codebase review):
- Inconsistent SnackBar formatting across screens
- Some errors use Colors.red, others use default styling
- Error messages vary in specificity and user-friendliness

# Issues being addressed:
- Inconsistent UI error display (from CONCERNS.md)
- Need for user-friendly error messages
- Standardized SnackBar patterns across screens
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorDisplay utility in lib/utils/error_display.dart</name>
  <files>lib/utils/error_display.dart</files>
  <action>Create ErrorDisplay utility class with static methods:

1. showErrorSnackBar(BuildContext context, AppError error):
   - Maps AppError.type to user-friendly icon
   - Uses error.message for display (not technicalDetails)
   - Consistent styling (red background, white text, duration 4 seconds)
   - Logs error with appropriate AppLogger before showing
   - Icon mapping:
     * database: Icons.storage
     * network: Icons.wifi_off
     * validation: Icons.error_outline
     * backup: Icons.backup
     * unknown: Icons.warning

2. showSuccessSnackBar(BuildContext context, String message):
   - Green background, white text
   - Duration 2 seconds
   - Check icon
   - Logs with AppLogger.info

3. showErrorDialog(BuildContext context, AppError error) - for critical errors:
   - Shows AlertDialog with title, message, and "OK" button
   - Shows technicalDetails in collapsible section if available
   - Logs error with AppLogger.severe

Import material.dart for SnackBar, AlertDialog, Icons.

Do NOT add recovery actions in SnackBars (keep simple - informational only).</action>
  <verify>File exists at lib/utils/error_display.dart with all three static methods and proper icon mapping</verify>
  <done>ErrorDisplay utility created with showErrorSnackBar, showSuccessSnackBar, and showErrorDialog methods</done>
</task>

<task type="auto">
  <name>Task 2: Update TransactionProvider to catch and store AppError for UI display</name>
  <files>lib/providers/transaction_provider.dart</files>
  <action>Update TransactionProvider error handling:

1. Change _error type from String? to AppError?
2. Update loadTransactions() catch block:
   - If error is AppError, store it directly
   - Otherwise, wrap in AppError.fromException()
   - Log with AppLogger.provider.severe() before storing

3. Update addTransaction(), deleteTransaction(), updateTransaction():
   - Catch AppError from services
   - Store in _error field
   - Log appropriately before setting error

4. Add clearError() method to reset _error to null

Pattern:
```dart
try {
  // operation
} catch (e, st) {
  _error = e is AppError
      ? e
      : AppError.fromException(e, stackTrace: st);
  AppLogger.provider.severe('Failed to load transactions', _error);
  notifyListeners();
}
```

Add AppLogger import if not present (create AppLogger.provider in app_logger.dart if needed).

Do NOT show SnackBars in provider - that's UI layer responsibility.</action>
  <verify>TransactionProvider uses AppError for _error field, all catch blocks convert errors to AppError</verify>
  <done>TransactionProvider stores AppError for UI layer to display, no SnackBar calls in provider</done>
</task>

<task type="auto">
  <name>Task 3: Update HomeScreen to use ErrorDisplay for error messages</name>
  <files>lib/screens/home_screen.dart</files>
  <action>Replace all SnackBar error displays with ErrorDisplay:

1. Add ErrorDisplay import
2. Find all ScaffoldMessenger.of(context).showSnackBar calls with error content
3. Replace with:
   - If TransactionProvider._error is AppError: ErrorDisplay.showErrorSnackBar(context, error)
   - For string errors: wrap in AppError.fromException() first

4. Keep success SnackBars or replace with ErrorDisplay.showSuccessSnackBar()

5. Ensure ErrorDisplay is called after setState/provider updates

Search pattern: `ScaffoldMessenger.of(context).showSnackBar`

Typical replacement:
```dart
// Old:
ScaffoldMessenger.of(context).showSnackBar(
  SnackBar(content: Text('Failed to load transactions'))
);

// New:
if (provider.error != null) {
  ErrorDisplay.showErrorSnackBar(context, provider.error!);
}
```

Add AppLogger.home import (already present from Phase 1).</action>
  <verify>All error SnackBars use ErrorDisplay.showErrorSnackBar, success messages use ErrorDisplay.showSuccessSnackBar</verify>
  <done>HomeScreen uses ErrorDisplay for all error messaging, consistent formatting applied</done>
</task>

<task type="auto">
  <name>Task 4: Update SettingsScreen to use ErrorDisplay for error messages</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>Replace manual SnackBar construction with ErrorDisplay:

1. Add ErrorDisplay import
2. Replace validation error SnackBars (lines 65-82) with ErrorDisplay:
   - Create AppError(type: validation) for income/savings validation
   - Use ErrorDisplay.showErrorSnackBar()
   - Keep same user-facing messages

3. Replace backup error displays with ErrorDisplay:
   - For import/export failures, use ErrorDisplay.showErrorSnackBar()
   - For success, use ErrorDisplay.showSuccessSnackBar()

4. Keep HapticFeedback calls (they're for UX, not error display)

Search for all SnackBar constructors and replace.

Example validation replacement:
```dart
// Old:
ScaffoldMessenger.of(context).showSnackBar(
  const SnackBar(
    content: Text('Please enter a valid monthly income'),
    backgroundColor: Colors.red,
  ),
);

// New:
ErrorDisplay.showErrorSnackBar(
  context,
  AppError(
    type: AppErrorType.validation,
    message: 'Please enter a valid monthly income',
  ),
);
```

Add ErrorDisplay import at top.</action>
  <verify>All error and success SnackBars in SettingsScreen use ErrorDisplay utility</verify>
  <done>SettingsScreen uses ErrorDisplay for consistent error formatting</done>
</task>

<task type="auto">
  <name>Task 5: Update AnalyticsDashboardScreen to use ErrorDisplay for error messages</name>
  <files>lib/screens/analytics_dashboard_screen.dart</files>
  <action>Replace any error display with ErrorDisplay:

1. Add ErrorDisplay import
2. Find error handling patterns (try-catch blocks with setState)
3. Replace error SnackBars with ErrorDisplay.showErrorSnackBar()
4. Add AppLogger.analyticsUI for error logging

If screen doesn't have explicit error handling yet:
- Add try-catch around analysis loading
- Store error in local state
- Display with ErrorDisplay if error exists
- Log with AppLogger.analyticsUI

Pattern to follow:
```dart
try {
  // analysis loading
} catch (e, st) {
  final error = e is AppError
      ? e
      : AppError.fromException(e, stackTrace: st);
  AppLogger.analyticsUI.severe('Failed to load analytics', error);
  if (mounted) {
    ErrorDisplay.showErrorSnackBar(context, error);
  }
}
```

Add ErrorDisplay import at top.</action>
  <verify>AnalyticsDashboardScreen uses ErrorDisplay for error messages, logs with AppLogger.analyticsUI</verify>
  <done>AnalyticsDashboardScreen uses ErrorDisplay and logs errors appropriately</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `flutter analyze` passes with no errors
- [ ] ErrorDisplay utility imported and used in all screen files
- [ ] TransactionProvider stores AppError (not String) for errors
- [ ] No manual SnackBar construction with error content remains
- [ ] All screens log errors with appropriate AppLogger before displaying
</verification>

<success_criteria>

- ErrorDisplay utility created with showErrorSnackBar, showSuccessSnackBar, showErrorDialog
- All screens use ErrorDisplay for consistent error formatting
- TransactionProvider stores AppError for UI layer
- User-friendly messages shown (technical details hidden from UI)
- All errors logged with AppLogger before display
- No manual SnackBar error construction remaining
  </success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-02-SUMMARY.md`:

# Phase 3 Plan 2: UI Error Display Summary

**Standardized UI error display with ErrorDisplay utility and consistent SnackBar formatting**

## Accomplishments

- Created ErrorDisplay utility for consistent error messaging
- Updated TransactionProvider to store AppError for UI layer
- Replaced all manual error SnackBars with ErrorDisplay
- Added error logging with AppLogger before display

## Files Created/Modified

- `lib/utils/error_display.dart` - New error display utility
- `lib/providers/transaction_provider.dart` - AppError storage
- `lib/screens/home_screen.dart` - ErrorDisplay usage
- `lib/screens/settings_screen.dart` - ErrorDisplay usage
- `lib/screens/analytics_dashboard_screen.dart` - ErrorDisplay usage

## Decisions Made

- Keep error display simple (informational only, no recovery actions in SnackBars)
- Store AppError in provider (not String) for UI layer access
- Log all errors with AppLogger before showing to user
- Hide technical details from UI (use message only)

## Issues Encountered

None

## Next Step

Ready for 03-03-PLAN.md - Add error tracking for debugging
</output>
